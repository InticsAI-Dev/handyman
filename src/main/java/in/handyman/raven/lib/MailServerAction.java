package in.handyman.raven.lib;

import com.sendgrid.helpers.mail.Mail;
import com.sendgrid.helpers.mail.objects.Attachments;
import com.sendgrid.helpers.mail.objects.Content;
import com.sendgrid.helpers.mail.objects.Email;
import in.handyman.raven.lambda.action.ActionExecution;
import in.handyman.raven.lambda.action.IActionExecution;
import in.handyman.raven.lambda.doa.audit.ActionExecutionAudit;
import in.handyman.raven.lib.model.MailServer;
import com.sendgrid.*;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Base64;

/**
 * Auto Generated By Raven
 */
@ActionExecution(
        actionName = "MailServer"
)
public class MailServerAction implements IActionExecution {
    private final ActionExecutionAudit action;
    private final MailServer mailServer;

    public MailServerAction(final ActionExecutionAudit action, final Object mailServer) {
        this.mailServer = (MailServer) mailServer;
        this.action = action;
    }

    @Override
    public void execute() throws Exception {
        if (executeIf()) {
            sendEmail();
        }
    }

    @Override
    public boolean executeIf() {
        return mailServer.getCondition();
    }

    private void sendEmail() {
        // Initialize SendGrid
        SendGrid sendGrid = new SendGrid("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"); // Replace with your SendGrid API key

        Email from = new Email("admin@askjuno.com");

        // Create an Email object for the recipient
        Email to = new Email("blokesh1701@gmail.com");

        // Create a subject for the email
        String subject = "Subject of the email";

        // Create a Content object for the email body with HTML formatting
        Content content = new Content("text/html", "<p style='text-align: center;'>I hope this message finds you well. We appreciate your prompt submission of the invoice for %s. However, after a thorough review, we regret to inform you that we cannot process this invoice due to the following reasons:%n%n\" +     \"To expedite the resolution process, we kindly request that you make the necessary adjustments and promptly submit a revised invoice. Once we receive the corrected invoice, we will proceed with the payment process.%n%n\" +     \"If you have any questions or require further clarification regarding these issues, please do not hesitate to contact our accounts payable department at %s. We value our partnership with your company and aim to resolve this matter as efficiently as possible.%n%n\" +     \"Thank you for your attention to this matter, and we appreciate your cooperation in resolving these discrepancies promptly.%n%n\" +     \"Sincerely</p>");

        // Create a Mail object
        Mail mail = new Mail(from, subject, to, content);

        // Attach an image file
        Attachments attachments = new Attachments();
        attachments.setFilename("/home/logesh.b@zucisystems.com/Downloads/invoice-automation.png"); // Replace with the actual filename
        attachments.setType("image/png"); // Set the correct MIME type
        attachments.setContentId("imageId"); // Content ID for inline images
        attachments.setDisposition("inline");
        try {
            attachments.setContent(Base64.getEncoder().encodeToString(Files.readAllBytes(Paths.get("/home/logesh.b@zucisystems.com/Downloads/invoice-automation.png"))));
        } catch (IOException e) {
            e.printStackTrace();
        }
        mail.addAttachments(attachments);

        // Send the email
        try {
            Request request = new Request();
            request.setMethod(Method.POST);
            request.setEndpoint("mail/send");
            request.setBody(mail.build());
            Response response = sendGrid.api(request);

            // Check the response and handle any errors
            if (response.getStatusCode() >= 200 && response.getStatusCode() < 300) {
                System.out.println("Email sent successfully.");
            } else {
                System.err.println("Failed to send email. Status code: " + response.getStatusCode());
            }
        } catch (IOException ex) {
            ex.printStackTrace();
        }
    }
}
